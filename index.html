<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mason's DCF & Monte Carlo</title>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React and ReactDOM (Using specific versions for stability) -->
    <script crossorigin src="https://unpkg.com/react@18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    
    <!-- Recharts Dependencies -->
    <!-- Sometimes UMD builds need prop-types -->
    <script src="https://unpkg.com/prop-types@15.8.1/prop-types.min.js"></script>
    <!-- Recharts (Pinned version to ensure compatibility) -->
    <script src="https://unpkg.com/recharts@2.10.3/umd/Recharts.js"></script>
    
    <!-- Babel to translate JSX in the browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body { background-color: #f1f5f9; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo } = React;
        // access Recharts from the global window object
        const { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, ReferenceLine } = window.Recharts;

        // --- Icons (SVG replacements for Lucide to keep it simple) ---
        const Icons = {
            Calculator: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="16" height="20" x="4" y="2" rx="2"/><line x1="8" x2="16" y1="6" y2="6"/><line x1="16" x2="16" y1="14" y2="18"/><path d="M16 10h.01"/><path d="M12 10h.01"/><path d="M8 10h.01"/><path d="M12 14h.01"/><path d="M8 14h.01"/><path d="M12 18h.01"/><path d="M8 18h.01"/></svg>,
            TrendingUp: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="22 7 13.5 15.5 8.5 10.5 2 17"/><polyline points="16 7 22 7 22 13"/></svg>,
            Settings: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>,
            RefreshCw: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></svg>,
            Info: () => <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>
        };

        // --- Components ---

        const FinancialInput = ({ label, value, onChange, min, max, step, unit = '', tooltip }) => {
            const handleSliderChange = (e) => onChange(parseFloat(e.target.value));
            const handleInputChange = (e) => {
                const val = parseFloat(e.target.value);
                if (!isNaN(val)) onChange(val);
            };

            return (
                <div className="mb-6">
                    <div className="flex justify-between items-center mb-2">
                        <label className="text-sm font-medium text-slate-700 flex items-center gap-2">
                            {label}
                            {tooltip && (
                                <div className="group relative flex justify-center">
                                    <div className="text-slate-400 cursor-help"><Icons.Info /></div>
                                    <span className="absolute bottom-full mb-2 hidden group-hover:block w-48 p-2 bg-slate-800 text-white text-xs rounded shadow-lg z-10">
                                        {tooltip}
                                    </span>
                                </div>
                            )}
                        </label>
                        <div className="relative">
                            <input
                                type="number"
                                value={value}
                                onChange={handleInputChange}
                                className="w-24 text-right p-1 border border-slate-300 rounded text-sm focus:ring-2 focus:ring-blue-500 outline-none"
                            />
                            <span className="absolute right-8 top-1 text-slate-400 text-xs pointer-events-none">{unit}</span>
                        </div>
                    </div>
                    <input
                        type="range"
                        min={min}
                        max={max}
                        step={step}
                        value={value}
                        onChange={handleSliderChange}
                        className="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-blue-600"
                    />
                </div>
            );
        };

        const Card = ({ children, className = "" }) => (
            <div className={`bg-white p-6 rounded-xl shadow-sm border border-slate-100 ${className}`}>
                {children}
            </div>
        );

        const StatBox = ({ label, value, subtext, highlight = false }) => (
            <div className={`p-4 rounded-lg border ${highlight ? 'bg-blue-50 border-blue-100' : 'bg-slate-50 border-slate-100'}`}>
                <div className="text-xs text-slate-500 uppercase font-semibold tracking-wider">{label}</div>
                <div className={`text-2xl font-bold my-1 ${highlight ? 'text-blue-700' : 'text-slate-800'}`}>{value}</div>
                {subtext && <div className="text-xs text-slate-400">{subtext}</div>}
            </div>
        );

        function App() {
            const [activeTab, setActiveTab] = useState('dcf');

            // --- State: DCF Inputs ---
            const [revenue, setRevenue] = useState(1000);
            const [growthRate, setGrowthRate] = useState(10);
            const [fcfMargin, setFcfMargin] = useState(15);
            const [wacc, setWacc] = useState(9);
            const [terminalGrowth, setTerminalGrowth] = useState(2.5);
            const [shares, setShares] = useState(100);
            const [projectionYears, setProjectionYears] = useState(5);

            // --- State: Monte Carlo Inputs ---
            const [iterations, setIterations] = useState(1000);
            const [growthVolatility, setGrowthVolatility] = useState(5);
            const [marginVolatility, setMarginVolatility] = useState(2);
            
            // --- Calculations ---
            const runDCF = (r, g, m, w, tg, s, years) => {
                let totalPV = 0;
                let currentRevenue = r;

                for (let i = 1; i <= years; i++) {
                    currentRevenue = currentRevenue * (1 + g / 100);
                    const fcf = currentRevenue * (m / 100);
                    const pv = fcf / Math.pow(1 + w / 100, i);
                    totalPV += pv;
                }

                const safeWacc = Math.max(w, tg + 0.5); 
                const finalFCF = currentRevenue * (m / 100);
                const terminalValue = (finalFCF * (1 + tg / 100)) / ((safeWacc - tg) / 100);
                const terminalPV = terminalValue / Math.pow(1 + safeWacc / 100, years);

                const equityValue = totalPV + terminalPV;
                const sharePrice = equityValue / s;

                return { sharePrice, equityValue, terminalPV, totalPV };
            };

            const baseCase = useMemo(() => {
                return runDCF(revenue, growthRate, fcfMargin, wacc, terminalGrowth, shares, projectionYears);
            }, [revenue, growthRate, fcfMargin, wacc, terminalGrowth, shares, projectionYears]);

            const [simulationResults, setSimulationResults] = useState(null);

            const runSimulation = () => {
                const results = [];
                const getNormalRandom = (mean, stdDev) => {
                    let u = 0, v = 0;
                    while(u === 0) u = Math.random();
                    while(v === 0) v = Math.random();
                    const z = Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2.0 * Math.PI * v);
                    return mean + z * stdDev;
                };

                for (let i = 0; i < iterations; i++) {
                    const simGrowth = getNormalRandom(growthRate, growthVolatility);
                    const simMargin = getNormalRandom(fcfMargin, marginVolatility);
                    const res = runDCF(revenue, simGrowth, simMargin, wacc, terminalGrowth, shares, projectionYears);
                    if (res.sharePrice > 0 && res.sharePrice < 10000) {
                        results.push(res.sharePrice);
                    }
                }

                const min = Math.min(...results);
                const max = Math.max(...results);
                const bucketCount = 20;
                const range = max - min;
                const step = range / bucketCount;
                
                const histogram = Array.from({ length: bucketCount }, (_, i) => {
                    const lower = min + (i * step);
                    const upper = lower + step;
                    return {
                        range: `$${lower.toFixed(0)} - $${upper.toFixed(0)}`,
                        priceStart: lower,
                        count: results.filter(r => r >= lower && r < upper).length
                    };
                });

                const avg = results.reduce((a,b) => a + b, 0) / results.length;
                const sorted = [...results].sort((a, b) => a - b);
                const median = sorted[Math.floor(sorted.length / 2)];

                setSimulationResults({ histogram, avg, median, count: results.length });
            };

            return (
                <div className="min-h-screen bg-slate-100 font-sans text-slate-900 p-4 md:p-8">
                    <div className="max-w-6xl mx-auto">
                        <header className="mb-8">
                            <h1 className="text-3xl font-bold text-slate-800 flex items-center gap-2">
                                <div className="text-blue-600"><Icons.Calculator /></div>
                                Intrinsic Value Calculator
                            </h1>
                            <p className="text-slate-500 mt-2">
                                Mason's DCF & Monte Carlo Tool.
                            </p>
                        </header>

                        <div className="flex gap-2 mb-6 border-b border-slate-200">
                            <button onClick={() => setActiveTab('dcf')} className={`px-4 py-2 font-medium text-sm transition-colors rounded-t-lg ${activeTab === 'dcf' ? 'bg-white text-blue-600 border-t border-l border-r border-slate-200' : 'text-slate-500 hover:text-slate-700'}`}>DCF Analysis</button>
                            <button onClick={() => setActiveTab('montecarlo')} className={`px-4 py-2 font-medium text-sm transition-colors rounded-t-lg ${activeTab === 'montecarlo' ? 'bg-white text-blue-600 border-t border-l border-r border-slate-200' : 'text-slate-500 hover:text-slate-700'}`}>Monte Carlo Simulation</button>
                        </div>

                        <div className="grid grid-cols-1 lg:grid-cols-12 gap-6">
                            <div className="lg:col-span-4 space-y-4">
                                <Card>
                                    <div className="flex items-center gap-2 mb-6 text-slate-800 font-semibold border-b pb-2">
                                        <Icons.Settings />
                                        <span>Core Assumptions</span>
                                    </div>
                                    <FinancialInput label="Current Revenue" unit="$M" value={revenue} onChange={setRevenue} min={0} max={100000} step={10} tooltip="The starting TTM Revenue." />
                                    <FinancialInput label="Revenue Growth" unit="%" value={growthRate} onChange={setGrowthRate} min={-20} max={100} step={0.5} tooltip="Annual compounded growth rate." />
                                    <FinancialInput label="FCF Margin" unit="%" value={fcfMargin} onChange={setFcfMargin} min={-50} max={80} step={0.5} tooltip="FCF as % of Revenue." />
                                    <FinancialInput label="WACC" unit="%" value={wacc} onChange={setWacc} min={3} max={20} step={0.1} tooltip="Discount Rate." />
                                    <FinancialInput label="Terminal Growth" unit="%" value={terminalGrowth} onChange={setTerminalGrowth} min={0} max={6} step={0.1} tooltip="Perpetual growth rate." />
                                    <FinancialInput label="Shares Outstanding" unit="M" value={shares} onChange={setShares} min={1} max={10000} step={1} />
                                </Card>

                                {activeTab === 'montecarlo' && (
                                    <Card className="bg-blue-50 border-blue-100">
                                        <div className="flex items-center gap-2 mb-6 text-blue-800 font-semibold border-b border-blue-200 pb-2">
                                            <Icons.TrendingUp />
                                            <span>Volatility Inputs</span>
                                        </div>
                                        <FinancialInput label="Growth Volatility" unit="%" value={growthVolatility} onChange={setGrowthVolatility} min={0} max={20} step={0.5} tooltip="Std Dev of Growth." />
                                        <FinancialInput label="Margin Volatility" unit="%" value={marginVolatility} onChange={setMarginVolatility} min={0} max={20} step={0.5} tooltip="Std Dev of Margin." />
                                        <div className="mt-4">
                                            <button onClick={runSimulation} className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg flex items-center justify-center gap-2 transition-all">
                                                <Icons.RefreshCw /> Run Simulation ({iterations})
                                            </button>
                                        </div>
                                    </Card>
                                )}
                            </div>

                            <div className="lg:col-span-8">
                                {activeTab === 'dcf' ? (
                                    <div className="space-y-6">
                                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                            <StatBox label="Intrinsic Value / Share" value={`$${baseCase.sharePrice.toFixed(2)}`} subtext="Based on inputs" highlight={true} />
                                            <StatBox label="Equity Value" value={`$${(baseCase.equityValue / 1000).toFixed(2)}B`} subtext="Total Market Cap" />
                                            <StatBox label="Implied Multiple" value={`${(baseCase.equityValue / (revenue * (fcfMargin/100))).toFixed(1)}x`} subtext="P/FCF" />
                                        </div>

                                        <Card>
                                            <h3 className="text-lg font-semibold text-slate-700 mb-4">Value Composition</h3>
                                            <div className="flex h-8 rounded-full overflow-hidden bg-slate-100 mb-2">
                                                <div className="bg-blue-500 h-full transition-all duration-500" style={{ width: `${(baseCase.totalPV / baseCase.equityValue) * 100}%` }} />
                                                <div className="bg-indigo-400 h-full transition-all duration-500" style={{ width: `${(baseCase.terminalPV / baseCase.equityValue) * 100}%` }} />
                                            </div>
                                            <div className="flex justify-between text-xs text-slate-500">
                                                <div className="flex items-center gap-2"><div className="w-3 h-3 rounded-full bg-blue-500"></div>PV of Cash Flows (5yr): ${(baseCase.totalPV/shares).toFixed(2)}/sh</div>
                                                <div className="flex items-center gap-2"><div className="w-3 h-3 rounded-full bg-indigo-400"></div>Terminal Value: ${(baseCase.terminalPV/shares).toFixed(2)}/sh</div>
                                            </div>
                                        </Card>

                                        <Card>
                                            <h3 className="text-lg font-semibold text-slate-700 mb-4">Sensitivity Analysis (WACC vs Growth)</h3>
                                            <div className="overflow-x-auto">
                                                <table className="w-full text-sm text-right">
                                                    <thead>
                                                        <tr>
                                                            <th className="text-left p-2 text-slate-400 font-normal">WACC \ Growth</th>
                                                            {[growthRate-2, growthRate-1, growthRate, growthRate+1, growthRate+2].map(g => (
                                                                <th key={g} className="p-2 bg-slate-50 border border-white">{g.toFixed(1)}%</th>
                                                            ))}
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {[wacc-1, wacc-0.5, wacc, wacc+0.5, wacc+1].map(w => (
                                                            <tr key={w}>
                                                                <td className="p-2 bg-slate-50 border border-white font-medium">{w.toFixed(1)}%</td>
                                                                {[growthRate-2, growthRate-1, growthRate, growthRate+1, growthRate+2].map(g => {
                                                                    const res = runDCF(revenue, g, fcfMargin, w, terminalGrowth, shares, projectionYears);
                                                                    const isBase = w === wacc && g === growthRate;
                                                                    return (
                                                                        <td key={g} className={`p-2 border border-slate-100 ${isBase ? 'bg-blue-100 font-bold text-blue-700' : ''}`}>
                                                                            ${res.sharePrice.toFixed(2)}
                                                                        </td>
                                                                    )
                                                                })}
                                                            </tr>
                                                        ))}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </Card>
                                    </div>
                                ) : (
                                    <div className="space-y-6">
                                        {!simulationResults ? (
                                            <div className="h-64 flex flex-col items-center justify-center text-slate-400 border-2 border-dashed border-slate-200 rounded-xl bg-slate-50">
                                                <div className="opacity-20 mb-4"><Icons.TrendingUp /></div>
                                                <p>Set volatility inputs and run the simulation</p>
                                            </div>
                                        ) : (
                                            <>
                                                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                                    <StatBox label="Average Price" value={`$${simulationResults.avg.toFixed(2)}`} highlight={true} />
                                                    <StatBox label="Median Price" value={`$${simulationResults.median.toFixed(2)}`} />
                                                    <StatBox label="Simulations" value={simulationResults.count} />
                                                </div>
                                                <Card className="h-96">
                                                    <h3 className="text-lg font-semibold text-slate-700 mb-4">Price Distribution</h3>
                                                    <ResponsiveContainer width="100%" height="100%">
                                                        <BarChart data={simulationResults.histogram}>
                                                            <CartesianGrid strokeDasharray="3 3" vertical={false} />
                                                            <XAxis dataKey="priceStart" tickFormatter={(val) => `$${val.toFixed(0)}`} label={{ value: 'Share Price', position: 'insideBottom', offset: -5 }} height={30} fontSize={12} />
                                                            <YAxis fontSize={12} />
                                                            <Tooltip formatter={(value) => [value, 'Occurrences']} labelFormatter={(label, payload) => payload && payload.length ? payload[0].payload.range : label} />
                                                            <Bar dataKey="count" fill="#3b82f6" radius={[4, 4, 0, 0]} />
                                                            <ReferenceLine x={baseCase.sharePrice} stroke="red" strokeDasharray="3 3" label="Base Case" />
                                                        </BarChart>
                                                    </ResponsiveContainer>
                                                </Card>
                                            </>
                                        )}
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
